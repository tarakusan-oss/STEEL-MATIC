<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô - SLIT V.13.1 (With Home Btn)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap');
        
        body { font-family: 'Sarabun', sans-serif; background-color: #f4f6f7; color: #2c3e50; padding: 20px; }
        .container { max-width: 950px; margin: 0 auto; background: white; padding: 35px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); position: relative; }
        
        h1 { color: #2c3e50; text-align: center; border-bottom: 4px solid #e74c3c; padding-bottom: 15px; margin-top: 10px; }
        .sub-title { text-align: center; color: #7f8c8d; font-size: 0.9em; margin-bottom: 25px; }

        /* Home Button */
        .btn-home {
            position: absolute; top: 20px; left: 20px;
            text-decoration: none; background: #95a5a6; color: white; 
            padding: 8px 15px; border-radius: 20px; font-size: 0.9em; font-weight: bold;
            transition: 0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .btn-home:hover { background: #7f8c8d; transform: translateY(-2px); }

        /* Box Styles */
        .box { border: 1px solid #e0e0e0; padding: 25px; border-radius: 10px; margin-bottom: 25px; position: relative; background: #fff; }
        .box-title { 
            position: absolute; top: -14px; left: 20px; background: white; padding: 0 10px; 
            font-weight: bold; color: #d35400; font-size: 1.1em; 
        }

        .row { display: flex; align-items: center; margin-bottom: 15px; flex-wrap: wrap; }
        .row label { flex: 2; font-weight: 600; min-width: 200px; color: #34495e; }
        .row input[type="number"], .row input[type="text"], .row select { 
            flex: 1.5; padding: 10px; border: 1px solid #bdc3c7; border-radius: 6px; text-align: right; font-family: 'Sarabun'; font-size: 1em; 
        }
        .unit { width: 70px; margin-left: 10px; color: #7f8c8d; font-size: 0.9em; }

        /* Highlight Inputs */
        .auto-fill { background-color: #eaf2f8; color: #2980b9; font-weight: bold; border: 1px solid #a9cce3; cursor: not-allowed; }
        .highlight-hp { background-color: #fff8e1; color: #d35400; font-weight: bold; border: 1px solid #f39c12; }
        .cost-input { background-color: #f4ecf7; border: 1px solid #9b59b6 !important; color: #8e44ad; }
        .highlight-pallet { background-color: #e8daef; color: #8e44ad; font-weight: bold; border: 1px solid #af7ac5; }
        .highlight-coil { background-color: #d6eaf8; border: 1px solid #3498db !important; color: #2e86c1; font-weight: bold; }
        .highlight-recoil { background-color: #d1f2eb; border: 1px solid #2ecc71 !important; color: #27ae60; font-weight: bold; }
        .highlight-pack { background-color: #fadbd8; border: 1px solid #e74c3c !important; color: #c0392b; font-weight: bold; }

        /* Checkbox */
        .checkbox-wrapper { flex: 1.5; display: flex; align-items: center; gap: 10px; }
        .checkbox-wrapper input[type="checkbox"] { width: 22px; height: 22px; cursor: pointer; }

        /* Button */
        .btn-calc { 
            width: 100%; padding: 18px; border: none; background: #27ae60; color: white; 
            font-size: 1.5em; font-weight: bold; border-radius: 10px; cursor: pointer; transition: 0.2s; box-shadow: 0 5px 15px rgba(39, 174, 96, 0.4);
            margin-bottom: 15px;
        }
        .btn-calc:hover { background: #219150; transform: translateY(-3px); }

        /* Export Buttons */
        .export-group { display: flex; gap: 10px; justify-content: center; margin-top: 10px; }
        .btn-export {
            padding: 10px 20px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; color: white;
            display: flex; align-items: center; gap: 5px; font-size: 1em;
        }
        .btn-excel { background: #217346; } .btn-excel:hover { background: #1e6b40; }
        .btn-img { background: #e67e22; } .btn-img:hover { background: #d35400; }

        /* Result Area */
        #resultArea { margin-top: 35px; display: none; background: #fffde7; padding: 25px; border-radius: 12px; border: 2px dashed #f1c40f; }
        table { width: 100%; border-collapse: collapse; background: white; margin-top: 15px; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        th, td { border: 1px solid #ecf0f1; padding: 14px; text-align: right; }
        td:first-child { text-align: left; font-weight: bold; color: #2c3e50; }
        th { background: #34495e; color: white; text-align: center; font-weight: normal; }
        
        .sub-total-row { background: #fdf2e9; color: #d35400; font-weight: bold; }
        .grand-total-row { background: #d5f5e3; color: #196f3d; font-weight: bold; font-size: 1.3em; }
        .per-kg-row { background: #2c3e50; color: #f1c40f; font-weight: bold; font-size: 1.4em; text-shadow: 1px 1px 2px black; }
    </style>
</head>
<body>

<div class="container" id="captureArea">
    <a href="../index.html" class="btn-home">üè† ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</a>

    <h1>üêª Factory Cost Calculator V.13</h1>
    <div class="sub-title">‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô - SLIT (Version ‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå)</div>

    <div class="box">
        <div class="box-title">1. ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö (Raw Material)</div>
        
        <div class="row" style="background: #e8f6f3; padding: 15px; border-radius: 8px; border: 1px solid #1abc9c;">
            <label style="color: #16a085;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£ (Machine):</label>
            <select id="machineName" onchange="autoFillParams()" style="text-align: center; font-weight: bold; color: #16a085;">
                <option value="">-- ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --</option>
                <option value="S1">‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á S1 (Standard)</option>
                <option value="S2">‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á S2 (Heavy Duty)</option>
                <option value="S3">‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á S3 (Small/Precise)</option>
            </select>
            <span class="unit">Model</span>
        </div>

        <div class="row">
            <label>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏ô‡∏≤ (Thickness):</label>
            <input type="number" id="thickness" placeholder="‡πÄ‡∏ä‡πà‡∏ô 1.2" oninput="autoFillParams()"> <span class="unit">mm</span>
        </div>
        <div class="row">
            <label>‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏°‡πâ‡∏ß‡∏ô‡∏£‡∏ß‡∏° (Total Weight):</label>
            <input type="number" id="weight" placeholder="5000"> <span class="unit">kg</span>
        </div>
        
        <div class="row">
            <label style="color: #2980b9;">üåÄ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏°‡πâ‡∏ß‡∏ô (Coil Qty):</label>
            <input type="number" id="coilQty" class="highlight-coil" value="1" min="1"> <span class="unit">‡∏°‡πâ‡∏ß‡∏ô</span>
        </div>

        <div class="row">
            <label>‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏ß‡πâ‡∏≤‡∏á (Width):</label>
            <input type="number" id="width" placeholder="1219"> <span class="unit">mm</span>
        </div>
        <div class="row">
            <label style="color: #2980b9;">üìè ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì (Length):</label>
            <input type="text" id="calcLength" class="auto-fill" readonly value="0.00"> <span class="unit">m</span>
        </div>
    </div>

    <div id="slitSection" class="box">
        <div class="box-title">2. ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á SLIT (Auto DB) üåÄ</div>
        
        <div class="row">
            <label>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏°‡∏≠‡πÄ‡∏ï‡∏≠‡∏£‡πå (Horsepower):</label>
            <input type="number" id="slitHP" class="auto-fill" readonly> <span class="unit">HP</span>
        </div>
        
        <div class="row" style="background: #fff8e1; border: 1px solid #f39c12; padding: 10px; border-radius: 6px;">
            <label style="color:#d35400;">‚ö° %HP Real Load (‡∏ï‡∏≤‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏ô‡∏≤):</label>
            <input type="text" id="hpLoadShow" class="highlight-hp" readonly value="-" style="width: 80px; text-align:center;"> 
            <span style="font-size:0.8em; color:#d35400; margin-left:10px;">(‡∏à‡∏≤‡∏Å DB)</span>
            <input type="number" id="percentHP" style="width: 60px; margin-left: 10px;" placeholder="Manual"> 
        </div>

        <div class="row" style="margin-top: 15px;">
            <label>‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á (Speed):</label>
            <input type="number" id="slitSpeed" class="auto-fill" readonly> <span class="unit">m/min</span>
        </div>
        <div class="row">
            <label>‡πÄ‡∏ß‡∏•‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏°‡∏µ‡∏î (Setup Time):</label>
            <input type="number" id="slitSetup" class="auto-fill" readonly> <span class="unit">min</span>
        </div>
        
        <div class="row">
            <label style="color: #27ae60;">‚è±Ô∏è ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏≠‡∏≤‡∏•‡∏π‡∏Å‡∏≠‡∏≠‡∏Å (Recoil Out):</label>
            <input type="number" id="recoilOutTime" class="highlight-recoil" value="20"> <span class="unit">min/‡∏°‡πâ‡∏ß‡∏ô</span>
        </div>

        <div class="row" style="margin-top: 20px;">
            <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏ö‡πà‡∏á‡∏Ñ‡∏≠‡∏¢‡∏•‡πå (Break Count):</label>
            <input type="number" id="breakCount" value="0" placeholder="0"> <span class="unit">‡∏Ñ‡∏£‡∏±‡πâ‡∏á</span>
        </div>

        <div class="row">
            <label>‡πÄ‡∏ß‡∏•‡∏≤‡∏°‡πâ‡∏ß‡∏ô‡∏Ñ‡∏∑‡∏ô (Coil Back):</label>
            <div class="checkbox-wrapper">
                <input type="checkbox" id="useCoilBack">
                <span style="font-size:0.9em;">‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏°‡πâ‡∏ß‡∏ô‡∏Å‡∏•‡∏±‡∏ö (‡πÄ‡∏ß‡∏•‡∏≤‡∏ï‡∏≤‡∏°‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á)</span>
            </div>
        </div>

        <input type="hidden" id="dbBreakTime">
        <input type="hidden" id="dbCoilBackTime">
    </div>

    <div class="box">
        <div class="box-title">3. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô (Cost Settings) üí∞</div>
        
        <div class="row" style="background: #e8daef; border: 1px solid #af7ac5; padding: 10px; border-radius: 6px;">
            <label style="color:#8e44ad;">üì¶ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏û‡∏≤‡πÄ‡∏•‡∏ó (Pallet Qty):</label>
            <input type="number" id="palletQty" class="highlight-pallet" value="0" placeholder="0"> <span class="unit">‡∏•‡∏±‡∏á</span>
        </div>
        <div class="row" style="background: #e8daef; border: 1px solid #af7ac5; padding: 10px; border-radius: 6px; margin-top: -10px;">
            <label style="color:#8e44ad;">ü™µ ‡∏Ñ‡πà‡∏≤‡πÑ‡∏°‡πâ‡∏ï‡πà‡∏≠‡∏•‡∏±‡∏á (Pallet Price):</label>
            <input type="number" id="palletPrice" class="highlight-pallet" value="400"> <span class="unit">‡∏ö‡∏≤‡∏ó</span>
        </div>

        <div class="row" style="background: #fadbd8; border: 1px solid #e74c3c; padding: 10px; border-radius: 6px; margin-top: 15px;">
            <label style="color:#c0392b;">‚è±Ô∏è ‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏û‡πá‡∏Ñ‡∏ï‡πà‡∏≠‡∏•‡∏±‡∏á (Packing Time):</label>
            <input type="number" id="packingTimePerPallet" class="highlight-pack" value="20"> <span class="unit">min/‡∏•‡∏±‡∏á</span>
        </div>

        <div class="row" style="margin-top: 15px;">
            <label style="color:#8e44ad;">üè¢ ‡∏Ñ‡πà‡∏≤‡πÇ‡∏™‡∏´‡∏∏‡πâ‡∏¢ (Overhead):</label>
            <input type="number" id="overheadCost" class="cost-input" value="500"> <span class="unit">‡∏ö‡∏≤‡∏ó/‡∏á‡∏≤‡∏ô</span>
        </div>
        <div class="row">
            <label style="color:#8e44ad;">üöú ‡∏Ñ‡πà‡∏≤‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏¢‡πâ‡∏≤‡∏¢ (Handling):</label>
            <input type="number" id="handlingCost" class="cost-input" value="100"> <span class="unit">‡∏ö‡∏≤‡∏ó/‡∏á‡∏≤‡∏ô</span>
        </div>

        <hr style="border: 0; border-top: 1px dashed #ccc; margin: 15px 0;">

        <div class="row">
            <label>‡∏Ñ‡πà‡∏≤‡πÅ‡∏£‡∏á‡∏ï‡πà‡∏≠‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á (Labor Rate):</label>
            <input type="number" id="laborRate" value="75"> <span class="unit">‡∏ö‡∏≤‡∏ó/‡∏ä‡∏°.</span>
        </div>
        <div class="row">
            <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏ô‡∏á‡∏≤‡∏ô (Manpower):</label>
            <input type="number" id="manpower" value="5"> <span class="unit">‡∏Ñ‡∏ô</span>
        </div>
        <div class="row">
            <label>‡∏Ñ‡πà‡∏≤‡πÑ‡∏ü‡∏ü‡πâ‡∏≤‡∏ï‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢ (Electricity Rate):</label>
            <input type="number" id="elecRate" value="5.0"> <span class="unit">‡∏ö‡∏≤‡∏ó/Unit</span>
        </div>
    </div>

    <button class="btn-calc" onclick="calculate()">üí∞ ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï (Calculate Cost) üí∞</button>

    <div id="resultArea">
        <h2 style="text-align: center; color: #d35400;">üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï (Production Cost)</h2>
        <div id="warningMsg" style="color: red; text-align: center; font-weight: bold; margin-bottom: 10px;"></div>
        
        <table id="resultTable">
            <thead>
                <tr>
                    <th width="40%">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (Item)</th>
                    <th width="30%">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î (Details)</th>
                    <th width="30%">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô (Amount)</th>
                </tr>
            </thead>
            <tbody id="resultBody"></tbody>
            <tfoot>
                <tr class="sub-total-row">
                    <td colspan="2">1. ‡∏£‡∏ß‡∏°‡πÄ‡∏ß‡∏•‡∏≤‡∏ú‡∏•‡∏¥‡∏ï (Total Labor Time)</td>
                    <td id="grandTime">0.00 ‡∏ô‡∏≤‡∏ó‡∏µ</td>
                </tr>
                <tr>
                    <td colspan="2">2. ‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏Ñ‡πà‡∏≤‡πÅ‡∏£‡∏á (Labor Cost)</td>
                    <td id="laborCostTotal">0.00 ‡∏ö‡∏≤‡∏ó</td>
                </tr>
                <tr>
                    <td colspan="2">3. ‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏Ñ‡πà‡∏≤‡πÑ‡∏ü‡∏ü‡πâ‡∏≤ (Energy Cost) <small style="color:gray; font-size:0.8em;" id="energyDetailText">(‡∏Ñ‡∏¥‡∏î‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Setup+Run)</small></td>
                    <td id="energyCostTotal">0.00 ‡∏ö‡∏≤‡∏ó</td>
                </tr>
                <tr>
                    <td colspan="2">4. ‡∏Ñ‡πà‡∏≤‡πÑ‡∏°‡πâ‡∏û‡∏≤‡πÄ‡∏•‡∏ó (Pallet Cost)</td>
                    <td id="palletCostTotal">0.00 ‡∏ö‡∏≤‡∏ó</td>
                </tr>
                <tr>
                    <td colspan="2">5. ‡∏Ñ‡πà‡∏≤‡πÇ‡∏™‡∏´‡∏∏‡πâ‡∏¢ (Overhead)</td>
                    <td id="overheadTotal">0.00 ‡∏ö‡∏≤‡∏ó</td>
                </tr>
                <tr>
                    <td colspan="2">6. ‡∏Ñ‡πà‡∏≤‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏¢‡πâ‡∏≤‡∏¢ (Handling)</td>
                    <td id="handlingTotal">0.00 ‡∏ö‡∏≤‡∏ó</td>
                </tr>
                <tr class="grand-total-row">
                    <td colspan="2" style="text-align: center;">‡∏£‡∏ß‡∏°‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏¥‡πâ‡∏ô (Grand Total)</td>
                    <td id="grandTotalCost">0.00 ‡∏ö‡∏≤‡∏ó</td>
                </tr>
                <tr class="per-kg-row">
                    <td colspan="2" style="text-align: center;">üí∞ ‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏ï‡πà‡∏≠‡∏Å‡∏¥‡πÇ‡∏•‡∏Å‡∏£‡∏±‡∏° (Cost per Kg) üí∞</td>
                    <td id="costPerKg">0.00 THB/kg</td>
                </tr>
            </tfoot>
        </table>

        <div class="export-group">
            <button class="btn-export btn-excel" onclick="exportToExcel()">
                üì• Export Excel
            </button>
            <button class="btn-export btn-img" onclick="saveAsImage()">
                üì∏ Save Image
            </button>
        </div>
    </div>
</div>

<script>
    const machineDB = {
        "S1": [
            { min: 0, max: 1.2, speed: 100, setup: 25, break: 10, back: 15, hp: 290, load: 60 },
            { min: 1.21, max: 2.3, speed: 80, setup: 25, break: 10, back: 15, hp: 290, load: 75 }
        ],
        "S2": [
            { min: 0, max: 3.19, speed: 80, setup: 25, break: 10, back: 15, hp: 923, load: 60 },
            { min: 3.2, max: 9.99, speed: 60, setup: 25, break: 10, back: 15, hp: 923, load: 80 }
        ],
        "S3": [
            { min: 0, max: 0.99, speed: 80, setup: 30, break: 20, back: 15, hp: 25, load: 50 },
            { min: 1, max: 2, speed: 60, setup: 30, break: 20, back: 15, hp: 25, load: 65 }
        ]
    };

    function autoFillParams() {
        const weight = parseFloat(document.getElementById('weight').value) || 0;
        const thickness = parseFloat(document.getElementById('thickness').value) || 0;
        const width = parseFloat(document.getElementById('width').value) || 0;
        
        let length = 0;
        if(thickness > 0 && width > 0) {
            length = weight / (thickness * 7.85 * (width/1000));
        }
        document.getElementById('calcLength').value = length.toFixed(2);

        const machine = document.getElementById('machineName').value;
        
        document.getElementById('slitSpeed').value = "";
        document.getElementById('slitSetup').value = "";
        document.getElementById('slitHP').value = ""; 
        document.getElementById('percentHP').value = "";
        document.getElementById('hpLoadShow').value = "-";
        document.getElementById('dbBreakTime').value = 0;
        document.getElementById('dbCoilBackTime').value = 0;
        document.getElementById('warningMsg').innerText = "";

        if (machine && thickness > 0) {
            const specs = machineDB[machine];
            let found = false;

            for (let spec of specs) {
                if (thickness >= spec.min && thickness <= spec.max) {
                    document.getElementById('slitSpeed').value = spec.speed;
                    document.getElementById('slitSetup').value = spec.setup;
                    document.getElementById('slitHP').value = spec.hp;
                    document.getElementById('dbBreakTime').value = spec.break;
                    document.getElementById('dbCoilBackTime').value = spec.back;
                    document.getElementById('percentHP').value = spec.load;
                    document.getElementById('hpLoadShow').value = spec.load + "%";
                    found = true;
                    break;
                }
            }
            if (!found) document.getElementById('warningMsg').innerText = `‚ö†Ô∏è ‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô: ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á ${machine} ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏ô‡∏≤ ${thickness} mm`;
        }
    }

    function calculate() {
        try {
            autoFillParams(); 

            const weightInput = parseFloat(document.getElementById('weight').value) || 0;
            const coilQty = parseFloat(document.getElementById('coilQty').value) || 1;
            const laborRatePerHour = parseFloat(document.getElementById('laborRate').value) || 0;
            const laborRatePerMin = laborRatePerHour / 60;
            const manpower = parseFloat(document.getElementById('manpower').value) || 0;
            const elecRate = parseFloat(document.getElementById('elecRate').value) || 0; 
            const totalLength = parseFloat(document.getElementById('calcLength').value) || 0;

            let totalTime = 0;
            let htmlRows = '';

            const speed = parseFloat(document.getElementById('slitSpeed').value) || 0;
            const setupPerCoil = parseFloat(document.getElementById('slitSetup').value) || 0;
            const totalSetup = setupPerCoil * coilQty; 

            const recoilOutPerCoil = parseFloat(document.getElementById('recoilOutTime').value) || 0;
            const totalRecoilOut = recoilOutPerCoil * coilQty; 

            const machineHP = parseFloat(document.getElementById('slitHP').value) || 0; 
            const loadPercent = parseFloat(document.getElementById('percentHP').value) || 80;
            
            const breakCount = parseFloat(document.getElementById('breakCount').value) || 0;
            const breakTimePerOne = parseFloat(document.getElementById('dbBreakTime').value) || 0;
            const totalBreak = breakCount * breakTimePerOne; 

            const isBack = document.getElementById('useCoilBack').checked;
            const backTimePerCoil = parseFloat(document.getElementById('dbCoilBackTime').value) || 0;
            const totalBackTime = isBack ? (backTimePerCoil * coilQty) : 0; 

            const palletQty = parseFloat(document.getElementById('palletQty').value) || 0;
            const palletPrice = parseFloat(document.getElementById('palletPrice').value) || 0;
            const packingTimePerPallet = parseFloat(document.getElementById('packingTimePerPallet').value) || 0;
            const totalPackingTime = palletQty * packingTimePerPallet;

            const overhead = parseFloat(document.getElementById('overheadCost').value) || 0;
            const handling = parseFloat(document.getElementById('handlingCost').value) || 0;

            if(document.getElementById('machineName').value === "") { alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£ (Machine) ‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡πà‡∏∞"); return; }
            if(speed === 0) { alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Spec ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á ‡∏´‡∏£‡∏∑‡∏≠ ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏ô‡∏≤ (Thickness) ‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏∞"); return; }
            if(weightInput === 0) { alert("‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏°‡πâ‡∏ß‡∏ô (Weight) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ö‡∏≤‡∏ó/‡∏Å‡∏Å."); return; }
            
            const runTime = totalLength / speed;
            
            // Labor Time = Total Everything
            totalTime = totalSetup + runTime + totalRecoilOut + totalBreak + totalBackTime + totalPackingTime;

            // Energy Time = Only Setup + Running (As requested)
            const energyTime = totalSetup + runTime;

            htmlRows += `<tr><td>1. Setup Time (${coilQty} ‡∏°‡πâ‡∏ß‡∏ô)</td><td>${setupPerCoil} x ${coilQty}</td><td>${totalSetup.toFixed(2)} min</td></tr>`;
            htmlRows += `<tr><td>2. Running Time</td><td>Len ${totalLength.toFixed(0)}m / Spd ${speed}</td><td>${runTime.toFixed(2)} min</td></tr>`;
            htmlRows += `<tr><td>3. Recoil Out (${coilQty} ‡∏°‡πâ‡∏ß‡∏ô)</td><td>${recoilOutPerCoil} x ${coilQty}</td><td>${totalRecoilOut.toFixed(2)} min</td></tr>`;
            if(breakCount > 0) htmlRows += `<tr><td>4. Break Time</td><td>${breakCount} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</td><td>${totalBreak.toFixed(2)} min</td></tr>`;
            if(isBack) htmlRows += `<tr><td>5. Coil Back</td><td>${backTimePerCoil} x ${coilQty}</td><td>${totalBackTime.toFixed(2)} min</td></tr>`;
            if(palletQty > 0) htmlRows += `<tr><td>6. Packing Time</td><td>${palletQty} ‡∏•‡∏±‡∏á x ${packingTimePerPallet} min</td><td>${totalPackingTime.toFixed(2)} min</td></tr>`;

            // 1. Labor
            const totalLaborCost = totalTime * manpower * laborRatePerMin;
            
            // 2. Energy (Only Setup + Run)
            const loadFactor = loadPercent / 100;
            const totalEnergyCost = (machineHP * 0.746 * loadFactor / 0.9) * (energyTime/60) * elecRate;

            // 3. Pallet Cost
            const totalPalletCost = palletQty * palletPrice;

            document.getElementById('resultBody').innerHTML = htmlRows;
            document.getElementById('grandTime').innerText = totalTime.toFixed(2) + " ‡∏ô‡∏≤‡∏ó‡∏µ";
            
            document.getElementById('laborCostTotal').innerText = totalLaborCost.toFixed(2) + " ‡∏ö‡∏≤‡∏ó";
            
            document.getElementById('energyDetailText').innerText = `(HP ${machineHP} x Load ${loadPercent}%) [‡∏Ñ‡∏¥‡∏î ${energyTime.toFixed(2)} min]`;
            document.getElementById('energyCostTotal').innerText = totalEnergyCost.toFixed(2) + " ‡∏ö‡∏≤‡∏ó";
            
            document.getElementById('palletCostTotal').innerText = `${totalPalletCost.toFixed(2)} ‡∏ö‡∏≤‡∏ó (${palletQty} x ${palletPrice})`;
            document.getElementById('overheadTotal').innerText = overhead.toFixed(2) + " ‡∏ö‡∏≤‡∏ó";
            document.getElementById('handlingTotal').innerText = handling.toFixed(2) + " ‡∏ö‡∏≤‡∏ó";

            const grandTotal = totalLaborCost + totalEnergyCost + totalPalletCost + overhead + handling;
            const costPerKg = grandTotal / weightInput;

            document.getElementById('grandTotalCost').innerText = grandTotal.toFixed(2) + " ‡∏ö‡∏≤‡∏ó";
            document.getElementById('costPerKg').innerText = costPerKg.toFixed(4) + " THB/kg";

            document.getElementById('resultArea').style.display = 'block';
        } catch(e) {
            alert("‚ö†Ô∏è Error: " + e.message + "\n\n(‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏ö‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏Å‡πà‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏¥‡πâ‡∏á‡∏Å‡πà‡∏≠‡∏ô‡∏ß‡∏≤‡∏á‡πÇ‡∏Ñ‡πâ‡∏î‡πÉ‡∏´‡∏°‡πà‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö)");
        }
    }

    function exportToExcel() {
        const table = document.getElementById("resultTable");
        const wb = XLSX.utils.table_to_book(table, {sheet: "SlitCost"});
        XLSX.writeFile(wb, "Slit_Cost_Calculation.xlsx");
    }

    function saveAsImage() {
        window.scrollTo(0,0);
        const element = document.getElementById("captureArea");
        html2canvas(element).then(canvas => {
            const link = document.createElement('a');
            link.download = 'Slit_Cost_Summary.png';
            link.href = canvas.toDataURL();
            link.click();
        });
    }
</script>

</body>
</html>