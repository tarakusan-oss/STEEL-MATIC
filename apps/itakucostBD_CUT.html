<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô - SHEAR V.10 (Multi-Coil + Export)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap');
        
        body { font-family: 'Sarabun', sans-serif; background-color: #f4f6f7; color: #2c3e50; padding: 20px; }
        .container { max-width: 950px; margin: 0 auto; background: white; padding: 35px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        
        h1 { color: #2c3e50; text-align: center; border-bottom: 4px solid #c0392b; padding-bottom: 15px; }
        .sub-title { text-align: center; color: #7f8c8d; font-size: 0.9em; margin-bottom: 25px; }

        /* Box Styles */
        .box { border: 1px solid #e0e0e0; padding: 25px; border-radius: 10px; margin-bottom: 25px; position: relative; background: #fff; }
        .box-title { 
            position: absolute; top: -14px; left: 20px; background: white; padding: 0 10px; 
            font-weight: bold; color: #c0392b; font-size: 1.1em; 
        }

        .row { display: flex; align-items: center; margin-bottom: 15px; flex-wrap: wrap; }
        .row label { flex: 2; font-weight: 600; min-width: 200px; color: #34495e; }
        .row input[type="number"], .row input[type="text"], .row select { 
            flex: 1.5; padding: 10px; border: 1px solid #bdc3c7; border-radius: 6px; text-align: right; font-family: 'Sarabun'; font-size: 1em; 
        }
        .unit { width: 70px; margin-left: 10px; color: #7f8c8d; font-size: 0.9em; }

        /* Highlight & Inputs */
        .auto-fill { background-color: #fdedec; color: #c0392b; font-weight: bold; border: 1px solid #fadbd8; cursor: not-allowed; }
        .smart-input { background-color: #eafaf1; border: 1px solid #2ecc71 !important; color: #27ae60; font-weight: bold; }
        .cost-input { background-color: #f4ecf7; border: 1px solid #9b59b6 !important; color: #8e44ad; }
        .highlight-hp { background-color: #fff8e1; color: #d35400; font-weight: bold; border: 1px solid #f39c12; }
        .highlight-pallet { background-color: #e8daef; color: #8e44ad; font-weight: bold; border: 1px solid #af7ac5; }
        .highlight-coil { background-color: #d6eaf8; border: 1px solid #3498db !important; color: #2e86c1; font-weight: bold; }

        /* Button */
        .btn-calc { 
            width: 100%; padding: 18px; border: none; background: #e74c3c; color: white; 
            font-size: 1.5em; font-weight: bold; border-radius: 10px; cursor: pointer; transition: 0.2s; box-shadow: 0 5px 15px rgba(231, 76, 60, 0.4);
            margin-bottom: 15px;
        }
        .btn-calc:hover { background: #c0392b; transform: translateY(-3px); }

        /* Export Buttons */
        .export-group { display: flex; gap: 10px; justify-content: center; margin-top: 10px; }
        .btn-export {
            padding: 10px 20px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; color: white;
            display: flex; align-items: center; gap: 5px; font-size: 1em;
        }
        .btn-excel { background: #217346; } .btn-excel:hover { background: #1e6b40; }
        .btn-img { background: #e67e22; } .btn-img:hover { background: #d35400; }

        /* Result Area */
        #resultArea { margin-top: 35px; display: none; background: #fffde7; padding: 25px; border-radius: 12px; border: 2px dashed #f1c40f; }
        table { width: 100%; border-collapse: collapse; background: white; margin-top: 15px; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        th, td { border: 1px solid #ecf0f1; padding: 14px; text-align: right; }
        td:first-child { text-align: left; font-weight: bold; color: #2c3e50; }
        th { background: #34495e; color: white; text-align: center; font-weight: normal; }
        
        .sub-total-row { background: #fdf2e9; color: #d35400; font-weight: bold; }
        .grand-total-row { background: #d5f5e3; color: #196f3d; font-weight: bold; font-size: 1.3em; }
        .per-kg-row { background: #2c3e50; color: #f1c40f; font-weight: bold; font-size: 1.4em; text-shadow: 1px 1px 2px black; }
        
        /* Radio Group */
        .radio-group { flex: 1.5; display: flex; gap: 15px; }
        .radio-item { display: flex; align-items: center; gap: 5px; cursor: pointer; }
    </style>
</head>
<body>

<div class="container" id="captureArea">
    <h1>‚úÇÔ∏è SHEAR Cost Calculator V.10</h1>
    <div class="sub-title">‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô - SHEAR (Multi-Coil + Export)</div>

    <div class="box">
        <div class="box-title">1. ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö (Raw Material)</div>
        
        <div class="row" style="background: #e8f6f3; padding: 10px; border-radius: 8px; border: 1px solid #1abc9c;">
            <label style="color: #16a085;">Machine:</label>
            <select id="machineName" onchange="autoFillDB()">
                <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --</option>
                <option value="L1">L1 (HP 212)</option>
                <option value="L2">L2 (HP 186)</option>
                <option value="L3">L3 (HP 520)</option>
                <option value="M1">M1 (HP 100)</option>
                <option value="M2">M2 (HP 70)</option>
                <option value="M3">M3 (HP 70)</option>
                <option value="M4">M4 (HP 70)</option>
            </select>
        </div>

        <div class="row">
            <label>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏ô‡∏≤ (Thickness):</label>
            <input type="number" id="thickness" placeholder="1.2" oninput="handleMaterialChange()"> <span class="unit">mm</span>
        </div>
        <div class="row">
            <label>‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏£‡∏ß‡∏° (Total Weight):</label>
            <input type="number" id="weight" placeholder="‡πÄ‡∏ä‡πà‡∏ô 20000" oninput="handleMaterialChange()"> <span class="unit">kg</span>
        </div>
        
        <div class="row">
            <label style="color: #2980b9;">üåÄ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏°‡πâ‡∏ß‡∏ô (No. of Coils):</label>
            <input type="number" id="coilQty" class="highlight-coil" value="1" min="1" oninput="handleMaterialChange()"> <span class="unit">‡∏°‡πâ‡∏ß‡∏ô</span>
        </div>

        <div class="row">
            <label>‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏ß‡πâ‡∏≤‡∏á (Width):</label>
            <input type="number" id="width" placeholder="1219" oninput="handleMaterialChange()"> <span class="unit">mm</span>
        </div>
        <div class="row">
            <label style="color: #c0392b;">üìè ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡∏£‡∏ß‡∏° (Total Length):</label>
            <input type="text" id="calcLength" class="auto-fill" readonly value="0.00"> <span class="unit">m</span>
        </div>
    </div>

    <div class="box">
        <div class="box-title">2. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡∏î‡πÅ‡∏•‡∏∞‡πÅ‡∏û‡πá‡∏Ñ (Smart Packing) üì¶</div>
        
        <div class="row">
            <label style="color:#2980b9; font-size:1.1em;">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡∏ï‡∏±‡∏î (Cut Length):</label>
            <input type="number" id="cutLength" placeholder="‡πÄ‡∏ä‡πà‡∏ô 2438" oninput="handleMaterialChange()"> <span class="unit">mm</span>
        </div>
        
        <div class="row" style="background: #fff8e1; border: 1px solid #f39c12; padding: 10px; border-radius: 6px;">
            <label style="color:#d35400;">‚ö° %HP Real Load (New DB):</label>
            <input type="text" id="hpLoadShow" class="highlight-hp" readonly value="-" style="width: 80px; text-align:center;"> 
            <span style="font-size:0.8em; color:#d35400; margin-left:10px;">(‡∏à‡∏≤‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á)</span>
            <input type="number" id="percentHP" style="width: 60px; margin-left: 10px;" placeholder="Override"> 
        </div>

        <div class="row" style="margin-top: 15px;">
            <label>üìÑ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏ú‡πà‡∏ô‡∏£‡∏ß‡∏° (Total Sheets):</label>
            <input type="text" id="totalSheetsShow" class="auto-fill" readonly value="0"> <span class="unit">‡πÅ‡∏ú‡πà‡∏ô</span>
        </div>

        <hr style="border: 0; border-top: 1px dashed #ccc; margin: 15px 0;">

        <div class="row" style="background: #fdfefe; border: 1px solid #abebc6; padding: 15px; border-radius: 8px;">
            <label style="color: #27ae60;">üü¢ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏ú‡πà‡∏ô‡∏ï‡πà‡∏≠‡∏•‡∏±‡∏á (Qty/Pallet):</label>
            <input type="number" id="sheetsPerPallet" class="smart-input" placeholder="‡πÉ‡∏™‡πà‡∏à‡∏≥‡∏ô‡∏ß‡∏ô..." oninput="updateWeightFromQty()"> 
            <span class="unit">‡πÅ‡∏ú‡πà‡∏ô</span>
        </div>
        
        <div class="row" style="background: #fdfefe; border: 1px solid #abebc6; padding: 15px; border-radius: 8px; margin-top: -10px;">
            <label style="color: #27ae60;">‚öñÔ∏è ‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏ï‡πà‡∏≠‡∏•‡∏±‡∏á (Weight/Pallet):</label>
            <input type="number" id="weightPerPallet" class="smart-input" placeholder="‡πÉ‡∏™‡πà Kg..." oninput="updateQtyFromWeight()"> 
            <span class="unit">kg</span>
        </div>

        <div class="row" style="margin-top: 15px;">
            <label style="color:#d35400;">‡∏Å‡∏£‡∏ì‡∏µ‡∏°‡∏µ‡πÄ‡∏®‡∏© (Remainder Logic):</label>
            <div class="radio-group">
                <div class="radio-item">
                    <input type="radio" id="optSeparate" name="remOption" value="separate" checked onchange="calculatePalletsPreview()">
                    <label for="optSeparate">üì¶ ‡πÅ‡∏¢‡∏Å‡∏•‡∏±‡∏á‡πÉ‡∏´‡∏°‡πà (+1)</label>
                </div>
                <div class="radio-item">
                    <input type="radio" id="optMerge" name="remOption" value="merge" onchange="calculatePalletsPreview()">
                    <label for="optMerge">üì• ‡∏£‡∏ß‡∏°‡∏•‡∏±‡∏á‡πÄ‡∏î‡∏¥‡∏°</label>
                </div>
            </div>
        </div>

        <div class="row" style="margin-top:10px;">
            <label>‡∏™‡∏£‡∏∏‡∏õ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏•‡∏±‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ:</label>
            <input type="text" id="calcPallets" class="auto-fill" readonly value="0"> <span class="unit">‡∏•‡∏±‡∏á</span>
        </div>
    </div>

    <input type="hidden" id="timePerStroke">
    <input type="hidden" id="shearHP">
    <input type="hidden" id="setupTime">
    <input type="hidden" id="palletTime">
    <input type="hidden" id="dbCoilBackTime">
    
    <div class="box">
        <div class="box-title">3. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï (Cost Settings) üí∞</div>
        
        <div class="row" style="background: #e8daef; border: 1px solid #af7ac5; padding: 10px; border-radius: 6px;">
            <label style="color:#8e44ad;">ü™µ ‡∏Ñ‡πà‡∏≤‡πÑ‡∏°‡πâ‡∏ï‡πà‡∏≠‡∏•‡∏±‡∏á (Auto Pallet Cost):</label>
            <input type="number" id="palletCostUnit" class="highlight-pallet" placeholder="Auto" readonly> <span class="unit">‡∏ö‡∏≤‡∏ó/‡∏•‡∏±‡∏á</span>
        </div>

        <div class="row" style="margin-top: 15px;">
            <label style="color:#8e44ad;">üè¢ ‡∏Ñ‡πà‡∏≤‡πÇ‡∏™‡∏´‡∏∏‡πâ‡∏¢ (Overhead):</label>
            <input type="number" id="overheadCost" class="cost-input" value="500"> <span class="unit">‡∏ö‡∏≤‡∏ó/‡∏á‡∏≤‡∏ô</span>
        </div>
        <div class="row">
            <label style="color:#8e44ad;">üöú ‡∏Ñ‡πà‡∏≤‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏¢‡πâ‡∏≤‡∏¢ (Handling):</label>
            <input type="number" id="handlingCost" class="cost-input" value="100"> <span class="unit">‡∏ö‡∏≤‡∏ó/‡∏á‡∏≤‡∏ô</span>
        </div>

        <hr style="border: 0; border-top: 1px dashed #ccc; margin: 15px 0;">

        <div class="row">
            <label>‡∏Ñ‡πà‡∏≤‡πÅ‡∏£‡∏á (Labor Rate):</label>
            <input type="number" id="laborRate" value="75"> <span class="unit">‡∏ö‡∏≤‡∏ó/‡∏ä‡∏°.</span>
        </div>
        <div class="row">
            <label>‡∏Ñ‡∏ô‡∏á‡∏≤‡∏ô (Manpower):</label>
            <input type="number" id="manpower" value="3"> <span class="unit">‡∏Ñ‡∏ô</span>
        </div>
        <div class="row">
            <label>‡∏Ñ‡πà‡∏≤‡πÑ‡∏ü (Elec Rate):</label>
            <input type="number" id="elecRate" value="5.0"> <span class="unit">‡∏ö‡∏≤‡∏ó/Unit</span>
        </div>
        <div class="row">
             <label>Coil Back (‡∏ó‡∏∏‡∏Å‡∏°‡πâ‡∏ß‡∏ô):</label>
             <div class="checkbox-wrapper"><input type="checkbox" id="useCoilBack"> <span style="font-size:0.9em;">‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏°‡πâ‡∏ß‡∏ô‡∏Å‡∏•‡∏±‡∏ö (x ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏°‡πâ‡∏ß‡∏ô)</span></div>
        </div>
    </div>

    <button class="btn-calc" onclick="calculateFinal()">‚úÇÔ∏è ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (Calculate) ‚úÇÔ∏è</button>

    <div id="resultArea">
        <h2 style="text-align: center; color: #c0392b;">üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï (Total Cost Breakdown)</h2>
        <div id="warnMsg" style="color:red; text-align:center;"></div>
        <table id="resultTable">
            <thead>
                <tr>
                    <th width="40%">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (Item)</th>
                    <th width="30%">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î (Details)</th>
                    <th width="30%">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô (Amount)</th>
                </tr>
            </thead>
            <tbody id="resultBody"></tbody>
            <tfoot>
                <tr class="sub-total-row"><td colspan="2">1. ‡∏£‡∏ß‡∏°‡πÄ‡∏ß‡∏•‡∏≤‡∏ú‡∏•‡∏¥‡∏ï (Total Time)</td><td id="grandTime">0.00 min</td></tr>
                
                <tr><td colspan="2">2. ‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏Ñ‡πà‡∏≤‡πÅ‡∏£‡∏á (Labor Cost)</td><td id="laborCostTotal">0.00 THB</td></tr>
                <tr><td colspan="2">3. ‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏Ñ‡πà‡∏≤‡πÑ‡∏ü‡∏ü‡πâ‡∏≤ (Energy Cost) <small style="color:gray" id="energyDetailText"></small></td><td id="energyCostTotal">0.00 THB</td></tr>
                <tr><td colspan="2">4. ‡∏Ñ‡πà‡∏≤‡πÑ‡∏°‡πâ‡∏û‡∏≤‡πÄ‡∏•‡∏ó (Pallet Cost) <small style="color:gray" id="palletDetailText"></small></td><td id="palletMatTotal">0.00 THB</td></tr>
                <tr><td colspan="2">5. ‡∏Ñ‡πà‡∏≤‡πÇ‡∏™‡∏´‡∏∏‡πâ‡∏¢ (Overhead)</td><td id="overheadTotal">0.00 THB</td></tr>
                <tr><td colspan="2">6. ‡∏Ñ‡πà‡∏≤‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏¢‡πâ‡∏≤‡∏¢ (Handling)</td><td id="handlingTotal">0.00 THB</td></tr>

                <tr class="grand-total-row"><td colspan="2" align="center">‡∏£‡∏ß‡∏°‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï (Grand Total)</td><td id="grandTotalCost">0.00 THB</td></tr>
                <tr class="per-kg-row"><td colspan="2" align="center">üí∞ ‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏ï‡πà‡∏≠‡∏Å‡∏¥‡πÇ‡∏•‡∏Å‡∏£‡∏±‡∏° (Cost per Kg) üí∞</td><td id="costPerKg">0.00 THB/kg</td></tr>
            </tfoot>
        </table>

        <div class="export-group">
            <button class="btn-export btn-excel" onclick="exportToExcel()">
                üì• Export Excel
            </button>
            <button class="btn-export btn-img" onclick="saveAsImage()">
                üì∏ Save Image
            </button>
        </div>
    </div>
</div>

<script>
    // --- DATABASE ---
    const machineDB = {
        "L1": [ 
            { min: 400, max: 499, stroke: 2, hp: 212, setup: 15, pallet: 10, back: 10, load: 20, palletCost: 250 },
            { min: 500, max: 999, stroke: 2.5, hp: 212, setup: 15, pallet: 10, back: 10, load: 20, palletCost: 300 },
            { min: 1000, max: 1999, stroke: 3, hp: 212, setup: 15, pallet: 10, back: 10, load: 20, palletCost: 400 },
            { min: 2000, max: 3000, stroke: 4, hp: 212, setup: 15, pallet: 10, back: 10, load: 20, palletCost: 500 }
        ],
        "L2": [ 
            { min: 400, max: 499, stroke: 2, hp: 186, setup: 15, pallet: 7, back: 10, load: 25, palletCost: 250 },
            { min: 500, max: 999, stroke: 2.4, hp: 186, setup: 15, pallet: 7, back: 10, load: 25, palletCost: 300 },
            { min: 1000, max: 1999, stroke: 2.8, hp: 186, setup: 15, pallet: 7, back: 10, load: 25, palletCost: 400 },
            { min: 2000, max: 3000, stroke: 3, hp: 186, setup: 15, pallet: 7, back: 10, load: 25, palletCost: 500 }
        ],
        "L3": [ 
            { min: 400, max: 499, stroke: 2, hp: 520, setup: 15, pallet: 5, back: 10, load: 30, palletCost: 250 },
            { min: 500, max: 999, stroke: 2.5, hp: 520, setup: 15, pallet: 5, back: 10, load: 30, palletCost: 300 },
            { min: 1000, max: 2500, stroke: 2.7, hp: 520, setup: 15, pallet: 5, back: 10, load: 30, palletCost: 400 }, 
            { min: 2501, max: 6000, stroke: 3, hp: 520, setup: 15, pallet: 5, back: 10, load: 30, palletCost: 500 }  
        ],
        "M1": [ 
            { min: 400, max: 999, stroke: 8, hp: 100, setup: 15, pallet: 10, back: 10, load: 70, palletCost: 250 },
            { min: 1000, max: 2001, stroke: 9, hp: 100, setup: 15, pallet: 10, back: 10, load: 70, palletCost: 300 },
            { min: 2002, max: 3050, stroke: 10, hp: 100, setup: 15, pallet: 10, back: 10, load: 70, palletCost: 400 },
            { min: 3051, max: 8000, stroke: 18, hp: 100, setup: 15, pallet: 10, back: 10, load: 65, palletCost: 500 }
        ],
        "M2": [ 
            { min: 400, max: 999, stroke: 7, hp: 70, setup: 15, pallet: 10, back: 10, load: 80, palletCost: 250 },
            { min: 1000, max: 2001, stroke: 8, hp: 70, setup: 15, pallet: 10, back: 10, load: 75, palletCost: 300 },
            { min: 2002, max: 3050, stroke: 9, hp: 70, setup: 15, pallet: 10, back: 10, load: 70, palletCost: 400 },
            { min: 3051, max: 8000, stroke: 15, hp: 70, setup: 15, pallet: 10, back: 10, load: 65, palletCost: 500 }
        ],
        "M3": [ 
            { min: 400, max: 999, stroke: 7, hp: 70, setup: 15, pallet: 10, back: 10, load: 80, palletCost: 250 },
            { min: 1000, max: 2001, stroke: 8, hp: 70, setup: 15, pallet: 10, back: 10, load: 75, palletCost: 300 },
            { min: 2002, max: 3050, stroke: 9, hp: 70, setup: 15, pallet: 10, back: 10, load: 70, palletCost: 400 },
            { min: 3051, max: 8000, stroke: 15, hp: 70, setup: 15, pallet: 10, back: 10, load: 65, palletCost: 500 }
        ],
        "M4": [ 
            { min: 400, max: 999, stroke: 7, hp: 70, setup: 15, pallet: 10, back: 10, load: 80, palletCost: 250 },
            { min: 1000, max: 2001, stroke: 8, hp: 70, setup: 15, pallet: 10, back: 10, load: 75, palletCost: 300 },
            { min: 2002, max: 3050, stroke: 9, hp: 70, setup: 15, pallet: 10, back: 10, load: 70, palletCost: 400 },
            { min: 3051, max: 8000, stroke: 15, hp: 70, setup: 15, pallet: 10, back: 10, load: 65, palletCost: 500 }
        ]
    };

    function getOneSheetWeight() {
        const thickness = parseFloat(document.getElementById('thickness').value) || 0;
        const widthMm = parseFloat(document.getElementById('width').value) || 0;
        const cutLenMm = parseFloat(document.getElementById('cutLength').value) || 0;
        if (thickness > 0 && widthMm > 0 && cutLenMm > 0) {
            return (thickness * widthMm * cutLenMm * 7.85) / 1000000;
        }
        return 0;
    }

    function handleMaterialChange() {
        const weightInput = parseFloat(document.getElementById('weight').value) || 0;
        const thickness = parseFloat(document.getElementById('thickness').value) || 0;
        const width = parseFloat(document.getElementById('width').value) || 0;
        const cutLenMm = parseFloat(document.getElementById('cutLength').value) || 0;
        
        let lengthM = 0;
        if(thickness > 0 && width > 0) lengthM = weightInput / (thickness * 7.85 * (width/1000));
        document.getElementById('calcLength').value = lengthM.toFixed(2);

        let totalSheets = 0;
        if(cutLenMm > 0 && lengthM > 0) totalSheets = Math.floor(lengthM / (cutLenMm / 1000));
        document.getElementById('totalSheetsShow').value = totalSheets;

        updateWeightFromQty();
        autoFillDB();
    }

    function updateWeightFromQty() {
        const qty = parseFloat(document.getElementById('sheetsPerPallet').value);
        const oneShtW = getOneSheetWeight();
        if (!isNaN(qty) && oneShtW > 0) {
            document.getElementById('weightPerPallet').value = (qty * oneShtW).toFixed(2);
        } else if (isNaN(qty)) document.getElementById('weightPerPallet').value = "";
        calculatePalletsPreview();
    }

    function updateQtyFromWeight() {
        const limitW = parseFloat(document.getElementById('weightPerPallet').value);
        const oneShtW = getOneSheetWeight();
        if (!isNaN(limitW) && limitW > 0 && oneShtW > 0) {
            document.getElementById('sheetsPerPallet').value = Math.floor(limitW / oneShtW);
        } else if (isNaN(limitW)) document.getElementById('sheetsPerPallet').value = "";
        calculatePalletsPreview();
    }

    function autoFillDB() {
        const machine = document.getElementById('machineName').value;
        const cutLen = parseFloat(document.getElementById('cutLength').value) || 0;
        
        document.getElementById('timePerStroke').value = "";
        document.getElementById('percentHP').value = "";
        document.getElementById('hpLoadShow').value = "-";
        document.getElementById('palletCostUnit').value = "";
        
        if (machine && cutLen > 0) {
            const specs = machineDB[machine];
            for (let spec of specs) {
                if (cutLen >= spec.min && cutLen <= spec.max) {
                    document.getElementById('timePerStroke').value = spec.stroke;
                    document.getElementById('shearHP').value = spec.hp;
                    document.getElementById('setupTime').value = spec.setup;
                    document.getElementById('palletTime').value = spec.pallet; 
                    document.getElementById('dbCoilBackTime').value = spec.back;
                    document.getElementById('percentHP').value = spec.load;
                    document.getElementById('hpLoadShow').value = spec.load + "%";
                    document.getElementById('palletCostUnit').value = spec.palletCost;
                    break;
                }
            }
        }
    }

    function calculatePalletsPreview() {
        const totalSheets = parseInt(document.getElementById('totalSheetsShow').value) || 0;
        const qtyPerPallet = parseInt(document.getElementById('sheetsPerPallet').value) || 0;
        const isSeparate = document.getElementById('optSeparate').checked;
        let palletCount = 0;
        if (totalSheets > 0 && qtyPerPallet > 0) {
            const full = Math.floor(totalSheets / qtyPerPallet);
            const rem = totalSheets % qtyPerPallet;
            palletCount = (rem === 0) ? full : (isSeparate ? full + 1 : (full===0?1:full));
        }
        document.getElementById('calcPallets').value = palletCount;
    }

    function calculateFinal() {
        try {
            handleMaterialChange(); 
            const weightInput = parseFloat(document.getElementById('weight').value) || 0;
            const totalSheets = parseInt(document.getElementById('totalSheetsShow').value) || 0;
            const palletCount = parseFloat(document.getElementById('calcPallets').value) || 0;
            
            const coilQty = parseFloat(document.getElementById('coilQty').value) || 1;
            const strokeTime = parseFloat(document.getElementById('timePerStroke').value);
            
            // Setup & Back Logic (Multiply by Coils)
            const setupPerCoil = parseFloat(document.getElementById('setupTime').value) || 0;
            const totalSetup = setupPerCoil * coilQty;

            const palletSetTime = parseFloat(document.getElementById('palletTime').value) || 0;
            const hp = parseFloat(document.getElementById('shearHP').value) || 0;
            
            let loadPercent = parseFloat(document.getElementById('percentHP').value) || 0;
            
            const isBack = document.getElementById('useCoilBack').checked;
            const backTimePerCoil = parseFloat(document.getElementById('dbCoilBackTime').value) || 0;
            const totalBackTime = isBack ? (backTimePerCoil * coilQty) : 0;
            
            const laborRate = parseFloat(document.getElementById('laborRate').value) || 0;
            const manpower = parseFloat(document.getElementById('manpower').value) || 0;
            const elecRate = parseFloat(document.getElementById('elecRate').value) || 0;
            const palletCostUnit = parseFloat(document.getElementById('palletCostUnit').value) || 0;
            const overhead = parseFloat(document.getElementById('overheadCost').value) || 0;
            const handling = parseFloat(document.getElementById('handlingCost').value) || 0;

            if(!strokeTime) { alert("‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Machine / Cut Length"); return; }
            if(weightInput === 0) { alert("‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏°‡πâ‡∏ß‡∏ô (Weight)"); return; }

            const runTime = (totalSheets * strokeTime) / 60;
            const handlingTime = palletCount * palletSetTime;
            const totalTime = totalSetup + runTime + handlingTime + totalBackTime;
            
            const laborCost = totalTime * manpower * (laborRate/60);
            const loadFactor = loadPercent / 100;
            const energyCost = (hp * 0.746 * loadFactor / 0.9) * (totalTime/60) * elecRate;
            const totalPalletMatCost = palletCount * palletCostUnit;
            const grandTotal = laborCost + energyCost + totalPalletMatCost + overhead + handling;
            const costPerKg = grandTotal / weightInput;

            let html = "";
            html += `<tr><td>1. Setup (${coilQty} coils)</td><td>${setupPerCoil} min x ${coilQty}</td><td>${totalSetup.toFixed(2)} min</td></tr>`;
            html += `<tr><td>2. Running</td><td>${totalSheets} pcs (${strokeTime}s)</td><td>${runTime.toFixed(2)} min</td></tr>`;
            html += `<tr><td>3. Pallet Time</td><td>${palletCount} plts x ${palletSetTime}min</td><td>${handlingTime.toFixed(2)} min</td></tr>`;
            if(isBack) html += `<tr><td>4. Coil Back</td><td>${backTimePerCoil} min x ${coilQty}</td><td>${totalBackTime.toFixed(2)} min</td></tr>`;

            document.getElementById('resultBody').innerHTML = html;
            document.getElementById('grandTime').innerText = totalTime.toFixed(2) + " min";
            document.getElementById('laborCostTotal').innerText = laborCost.toFixed(2) + " THB";
            document.getElementById('energyDetailText').innerText = `(HP ${hp} x Load ${loadPercent}%)`;
            document.getElementById('energyCostTotal').innerText = energyCost.toFixed(2) + " THB";
            document.getElementById('palletDetailText').innerText = `(${palletCostUnit} ‡∏ø/‡∏•‡∏±‡∏á)`;
            document.getElementById('palletMatTotal').innerText = `${totalPalletMatCost.toFixed(2)} THB`;
            document.getElementById('overheadTotal').innerText = overhead.toFixed(2) + " THB";
            document.getElementById('handlingTotal').innerText = handling.toFixed(2) + " THB";
            document.getElementById('grandTotalCost').innerText = grandTotal.toFixed(2) + " THB";
            document.getElementById('costPerKg').innerText = costPerKg.toFixed(4) + " THB/kg";
            document.getElementById('resultArea').style.display = 'block';
        } catch(e) {
            alert("‚ö†Ô∏è Error: " + e.message);
        }
    }

    function exportToExcel() {
        const table = document.getElementById("resultTable");
        const wb = XLSX.utils.table_to_book(table, {sheet: "ShearCost"});
        XLSX.writeFile(wb, "Shear_Cost_Calculation.xlsx");
    }

    function saveAsImage() {
        window.scrollTo(0,0);
        const element = document.getElementById("captureArea");
        html2canvas(element).then(canvas => {
            const link = document.createElement('a');
            link.download = 'Shear_Cost_Summary.png';
            link.href = canvas.toDataURL();
            link.click();
        });
    }
</script>

</body>
</html>